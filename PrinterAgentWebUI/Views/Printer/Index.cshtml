@model IEnumerable<PrinterAgent.WebUI.Controllers.AgentData>
@{
    Layout = "_Layout";
    ViewBag.Title = "Dashboard - Agents and Printers";
}

<h2>Dashboard</h2>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Agent ID</th>
            <th>Status</th>
            <th>Last Update (UTC)</th>
        </tr>
    </thead>
    <tbody id="agentStatusTable">
        <!-- Populated by JS -->
    </tbody>
</table>

<hr />

<h3>Printer Status by Agent</h3>
<div class="mb-3">
    <label for="agentSelect" class="form-label">Choose Agent</label>
    <select id="agentSelect" class="form-select">
        <option value="">-- Select an Agent --</option>
    </select>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Printer Name</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="printerTableBody">
        <!-- Populated by JS -->
    </tbody>
</table>

@section Scripts {
    <script>
        $(function() {
          // In‑memory store of latest data
          var agentsData = {};

          // 1) Update the dashboard table
          function updateAgentTable(data) {
            var now = new Date();
            var $tbody = $('#agentStatusTable').empty();
            data.forEach(function(agent) {
              var ts     = new Date(agent.timestamp);
              var diff   = (now - ts) / 1000;
              var online = diff < 60;
              var color  = online ? 'success' : 'danger';
              var fmt    = ts.toLocaleString('en-GB',{
                              day:'2-digit',month:'2-digit',year:'numeric',
                              hour:'2-digit',minute:'2-digit',second:'2-digit'
                            });
              $tbody.append(
                '<tr>' +
                  '<td>' + agent.machineName + '</td>' +
                  '<td class="fw-bold text-' + color + '">' +
                    (online ? 'Online' : 'Offline') +
                  '</td>' +
                  '<td>' + fmt + '</td>' +
                '</tr>'
              );
              // cache for later
              agentsData[agent.agentId] = agent;
            });
          }

          // 2) Populate the agent dropdown
          function populateAgentDropdown(data) {
            var $sel = $('#agentSelect').empty()
                        .append('<option value="">-- Select an Agent --</option>');
            data.forEach(function(agent) {
              $('<option>')
                .val(agent.agentId)
                .text(agent.machineName + ' (' + agent.agentId.substr(0,8) + ')')
                .appendTo($sel);
            });
          }

          // 3) When an agent is picked, show its printers
          $('#agentSelect').on('change', function() {
            var id   = $(this).val();
            var list = agentsData[id] ? agentsData[id].printers : [];
            var $b   = $('#printerTableBody').empty();
            list.forEach(function(p) {
              var bg = p.status === 'Online' ? 'bg-success' : 'bg-danger';
              $b.append(
                '<tr>' +
                  '<td>' + p.name + '</td>' +
                  '<td class="' + bg + ' text-white">' + p.status + '</td>' +
                '</tr>'
              );
            });
          });

          // 4) Fetch & refresh every 10s
          function loadAgentData() {
            $.getJSON('/api/printerdata', function(data) {
              updateAgentTable(data);
              populateAgentDropdown(data);
            });
          }

          loadAgentData();
          setInterval(loadAgentData, 10000);
        });
    </script>
}

