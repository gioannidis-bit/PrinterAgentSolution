@model IEnumerable<PrinterAgent.WebUI.Controllers.AgentData>
@{
    Layout = "_Layout";
    ViewBag.Title = "Dashboard - Agents and Printers";
}

<h2>Dashboard</h2>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Agent ID</th>
            <th>Status</th>
            <th>Last Update (UTC)</th>
        </tr>
    </thead>
    <tbody id="agentStatusTable">
        <!-- Populated by JS -->
    </tbody>
</table>

<hr />

<h3>Printer Status by Agent</h3>
<div class="mb-3">
    <label for="agentSelect" class="form-label">Choose Agent</label>
    <select id="agentSelect" class="form-select">
        <option value="">-- Select an Agent --</option>
    </select>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Printer Name</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="printerTableBody">
        <!-- Populated by JS -->
    </tbody>
</table>

@section Scripts {
    <script>
        // Holds latest agent → printer info
        var agentsData = {};

           function updateAgentTable(data) {
        var tbody = $('#agentStatusTable');
        tbody.empty();
        var now = new Date();
        $.each(data, function(index, agent) {
            // Convert the agent's timestamp into a Date object.
            var agentTimestamp = new Date(agent.timestamp);
            // Determine if the agent is online (last update within 60 seconds).
            var diffSec = (now - agentTimestamp) / 1000;
            var status = diffSec < 60 ? 'Online' : 'Offline';
            var color = diffSec < 60 ? 'green' : 'red';

            // Format the date to European format with day first.
            var formattedTimestamp = agentTimestamp.toLocaleString("en-GB", {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            var row = `<tr>
                <td>${agent.agentId}</td>
                <td style="color: ${color}; font-weight: bold;">${status}</td>
                <td>${formattedTimestamp}</td>
            </tr>`;
            tbody.append(row);
            // Save the agent data for later use.
            agentsData[agent.agentId] = agent;
        });
        }

        function populateAgentDropdown(data) {
          var select = $('#agentSelect').empty()
            .append('<option value="">-- Select an Agent --</option>');

          data.forEach(function(agent) {
            select.append(`<option value="${agent.agentId}">${agent.agentId}</option>`);
          });
        }

        // When you pick an agent, show its printers
        $('#agentSelect').on('change', function() {
          var agentId = $(this).val();
          var body = $('#printerTableBody').empty();

          if (!agentId || !agentsData[agentId]) return;

          agentsData[agentId].printers.forEach(function(p) {
            // background color
            var bgClass = p.status === 'Online' ? 'bg-success'
                         : 'bg-danger';
            body.append(`
              <tr>
                <td>${p.name}</td>
                <td class="${bgClass} text-white">${p.status}</td>
              </tr>`);
          });
        });

        function loadAgentData() {
          $.getJSON('/api/printerdata', function(data) {
            updateAgentTable(data);
            populateAgentDropdown(data);
          });
        }

        $(document).ready(function() {
          loadAgentData();
          setInterval(loadAgentData, 10000); // every 10s
        });
    </script>
}
